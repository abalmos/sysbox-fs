//
// Copyright: (C) 2019 Nestybox Inc.  All rights reserved.
//

package state

import (
	"strconv"
	"sync"
	"time"

	"github.com/nestybox/sysbox-fs/domain"
)

//
// Container type to represent all the container-state relevant to sysbox-fs.
//
type container struct {
	sync.RWMutex
	id            string              // container-id value generated by runC
	initPid       uint32              // initPid within container
	ctime         time.Time           // container creation time
	uidFirst      uint32              // first value of Uid range (host side)
	uidSize       uint32              // Uid range size
	gidFirst      uint32              // first value of Gid range (host side)
	gidSize       uint32              // Gid range size
	procRoPaths   []string            // OCI spec read-only proc paths
	procMaskPaths []string            // OCI spec masked proc paths
	specPaths     map[string]struct{} // OCI spec hashmap including all paths
	usernsInode   domain.Inode        // inode associated to container's user-ns
	dataStore     domain.StateDataMap // Handler's container-specific storage blob
}

//
// Getters implementations.
//

func (c *container) ID() string {
	c.RLock()
	defer c.RUnlock()

	return c.id
}

func (c *container) InitPid() uint32 {
	c.RLock()
	defer c.RUnlock()

	return c.initPid
}

func (c *container) Ctime() time.Time {
	c.RLock()
	defer c.RUnlock()

	return c.ctime
}

func (c *container) UserNsInode() domain.Inode {
	c.RLock()
	defer c.RUnlock()

	return c.usernsInode
}

func (c *container) UID() uint32 {
	c.RLock()
	defer c.RUnlock()

	return c.uidFirst
}

func (c *container) GID() uint32 {
	c.RLock()
	defer c.RUnlock()

	return c.gidFirst
}

func (c *container) ProcRoPaths() []string {
	c.RLock()
	defer c.RUnlock()

	return c.procRoPaths
}

func (c *container) ProcMaskPaths() []string {
	c.RLock()
	defer c.RUnlock()

	return c.procMaskPaths
}

func (c *container) IsSpecPath(s string) bool {
	c.RLock()
	defer c.RUnlock()

	_, ok := c.specPaths[s]
	if !ok {
		return false
	}

	return true
}

func (c *container) Data(path string, name string) (string, bool) {
	c.RLock()
	defer c.RUnlock()

	if c.dataStore == nil {
		return "", false
	}

	if _, ok := c.dataStore[path]; !ok {
		return "", false
	}

	return c.dataStore[path][name], true
}

// String() specialization for container type.
func (c *container) String() string {
	c.RLock()
	defer c.RUnlock()

	result := "\n\t\t id: " + c.id + "\n" +
		"\t\t initPid: " + strconv.Itoa(int(c.initPid)) + "\n" +
		"\t\t ctime: " + c.ctime.String() + "\n" +
		"\t\t usernsInode: " + strconv.FormatUint(c.usernsInode, 10) + "\n" +
		"\t\t UID: " + strconv.Itoa(int(c.uidFirst)) + "\n" +
		"\t\t GID: " + strconv.Itoa(int(c.gidFirst))

	return result
}

//
// Setters implementations.
//

func (c *container) SetCtime(t time.Time) {
	c.Lock()
	defer c.Unlock()

	c.ctime = t
}

func (c *container) SetData(path string, name string, data string) {
	c.Lock()
	defer c.Unlock()

	if c.dataStore == nil {
		c.dataStore = make(domain.StateDataMap)
	}

	if _, ok := c.dataStore[path]; !ok {
		c.dataStore[path] = make(domain.StateData)
	}

	c.dataStore[path][name] = data
}
